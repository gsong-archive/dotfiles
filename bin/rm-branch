#!/usr/bin/env python

"""
Used when local clone is Hg and origin is Git. A convenience script to remove
Git branches, which are just bookmarks in Hg.
"""

# TODO:
#   1. Put in argparse
#   2. Any way to autocomplete branch names? Yeah, blue sky!

import subprocess
import sys


def _run(cmd):
    cmd = ' && '.join(cmd)
    subprocess.call(cmd, shell=True)


def git_pre():
    cmd = [
        'git checkout master',
        'git pull',
        'git reset --hard origin/master',
    ]
    _run(cmd)


def hg_pre():
    cmd = [
        'hg update -C master',
        'hg pull',
    ]
    _run(cmd)


def hg_post():
    cmd = ['hg pull']
    _run(cmd)


def delete_git_branch(branch):
    cmd = [
        'git push origin :%s' % branch,
        'git branch -rd default/%s' % branch,
        'git branch -D %s' % branch,
    ]
    _run(cmd)


def delete_hg_branch(branch):
    cmd = [
        'hg update -C master',
        'hg bookmarks -d %s' % branch,
    ]
    _run(cmd)


def main():
    branches = sys.argv[1:]
    hg_pre()
    git_pre()
    for branch in branches:
        delete_hg_branch(branch)
        delete_git_branch(branch)
    hg_post()


if __name__ == '__main__':
    main()
